FROM docker:dind

RUN set -eux; \
	apk update && \
	apk add --no-cache \
		pigz \
        openssh-server \
        bash \
        shadow \
        sudo

RUN chmod 0640 /etc/shadow && echo "root:hardrootpassword" | chpasswd

ENV TESTUSER=mike
ENV UID=31337
ENV GID=31337

RUN set -x ; addgroup -g "$GID" -S "$TESTUSER" && \
	adduser \
	-g "$GID" \
	-D \
	-s "/bin/bash" \
	-h "/home/$TESTUSER" \
	-u "$UID" \
	-G "$TESTUSER" "$TESTUSER" && exit 0 ; exit 1

RUN echo "mike:hardmikepass" | chpasswd

RUN echo 'mike ALL=(root) NOPASSWD: /usr/bin/find' >> /etc/sudoers

# Docker java image
COPY java.tar /root/java.tar

COPY entrypoint.sh /entry.sh

RUN chmod +x /entry.sh

RUN echo -n 'find_4_sudo' \
		| md5sum \
		| cut -d' ' -f1 > /root/root.txt && \
	chmod 400 /root/root.txt
	
EXPOSE 22

COPY app.jar /root/app.jar

ENTRYPOINT /entry.sh
